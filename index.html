<script>
  const apiKey = "86f6772a666a8617d6b629fa9a4b3c62";  
  const movieIds = [238,603,597,496243,27205,155,680,122,13,550,424,862,314];
  const seriesIds = [1399,60735,1668,1412,456,4629,66732,1100];

  let peliculasData = [];
  let seriesData = [];
  let generosDisponibles = new Set();

  async function getDirector(id) {
    const res = await fetch(`https://api.themoviedb.org/3/movie/${id}/credits?api_key=${apiKey}`);
    const data = await res.json();
    const director = data.crew.find(c => c.job === "Director");
    return director ? director.name : "Desconocido";
  }

  function renderItem(data, type, containerId, director="") {
    const rating = data.vote_average * 10;
    const radius = 20;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (rating/100)*circumference;
    let color = rating>=70 ? "#21d07a" : rating>=40 ? "#d2d531" : "#db2360";
    const genres = data.genres.map(g=>g.name).join(", ");

    const div = document.createElement("div");
    div.className="pelicula";
    div.innerHTML=`
      <a href="https://www.themoviedb.org/${type}/${data.id}" target="_blank">
        <img src="https://image.tmdb.org/t/p/w300${data.poster_path}" alt="${data.title||data.name}">
        <p>${data.title||data.name}</p>
        <div class="rating-circle">
          <svg width="48" height="48">
            <circle cx="24" cy="24" r="${radius}" stroke="#444" stroke-width="3" fill="black"/>
            <circle class="progress" cx="24" cy="24" r="${radius}" stroke="${color}" stroke-width="3" fill="transparent"
              stroke-dasharray="${circumference}" stroke-dashoffset="${circumference}"/>
          </svg>
          <div class="rating-text">${data.vote_average.toFixed(1)}</div>
        </div>
        <div class="popup">
          <h3>${data.title||data.name}</h3>
          <p><strong>Estreno:</strong> ${data.release_date||data.first_air_date}</p>
          ${type==="movie"?`<p><strong>Director:</strong> ${director}</p>`:""}
          <p><strong>Género:</strong> ${genres}</p>
          <p>${data.overview}</p>
        </div>
      </a>`;
    document.getElementById(containerId).appendChild(div);
    setTimeout(()=>{div.querySelector(".progress").setAttribute("stroke-dashoffset",offset);},100);
  }

  // Cargar películas
  (async function(){
    for(let id of movieIds){
      const res = await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${apiKey}&language=es-ES`);
      const data = await res.json();
      const director = await getDirector(id);
      peliculasData.push({...data,director});
      data.genres.forEach(g=>generosDisponibles.add(g.name));
      renderItem(data,"movie","peliculas",director);
    }
    actualizarOpcionesGenero();
  })();

  // Cargar series
  (async function(){
    for(let id of seriesIds){
      const res = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${apiKey}&language=es-ES`);
      const data = await res.json();
      seriesData.push(data);
      data.genres.forEach(g=>generosDisponibles.add(g.name));
      renderItem(data,"tv","series");
    }
    actualizarOpcionesGenero();
  })();

  // Actualizar menú con géneros disponibles
  function actualizarOpcionesGenero(){
    const filtro = document.getElementById("filtro");
    // eliminar géneros previos
    [...filtro.options].forEach(opt=>{
      if(opt.dataset && opt.dataset.tipo==="genero") filtro.removeChild(opt);
    });
    // agregar nuevos
    generosDisponibles.forEach(g=>{
      const opt=document.createElement("option");
      opt.value="genero:"+g;
      opt.textContent="Género: "+g;
      opt.dataset.tipo="genero";
      filtro.appendChild(opt);
    });
  }

  // Funciones de filtro
  function ordenarPorTitulo(lista, contenedorId, type){
    document.getElementById(contenedorId).innerHTML="";
    lista.sort((a,b)=>(a.title||a.name).localeCompare(b.title||b.name))
         .forEach(item=>renderItem(item,type,contenedorId,item.director||""));
  }
  function ordenarPorAnio(lista, contenedorId, type){
    document.getElementById(contenedorId).innerHTML="";
    lista.sort((a,b)=>(a.release_date||a.first_air_date).localeCompare(b.release_date||b.first_air_date))
         .forEach(item=>renderItem(item,type,contenedorId,item.director||""));
  }
  function filtrarPorGenero(lista, contenedorId, type, genero){
    document.getElementById(contenedorId).innerHTML="";
    lista.filter(item=>item.genres.some(g=>g.name===genero))
         .forEach(item=>renderItem(item,type,contenedorId,item.director||""));
  }

  // Listener del filtro
  document.getElementById("filtro").addEventListener("change",function(){
    const valor=this.value;
    if(valor==="alfabetico"){
      ordenarPorTitulo(peliculasData,"peliculas","movie");
      ordenarPorTitulo(seriesData,"series","tv");
    } else if(valor==="anio"){
      ordenarPorAnio(peliculasData,"peliculas","movie");
      ordenarPorAnio(seriesData,"series","tv");
    } else if(valor.startsWith("genero:")){
      const genero=valor.split(":")[1];
      filtrarPorGenero(peliculasData,"peliculas","movie",genero);
      filtrarPorGenero(seriesData,"series","tv",genero);
    } else {
      // Sin filtro: volver a mostrar todo
      document.getElementById("peliculas").innerHTML="";
      peliculasData.forEach(item=>renderItem(item,"movie","peliculas",item.director||""));
      document.getElementById("series").innerHTML="";
      seriesData.forEach(item=>renderItem(item,"tv","series"));
    }
  });
</script>
